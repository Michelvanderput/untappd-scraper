name: Daily Beer Menu Scraper

on:
  schedule:
    # Draait 3x per dag voor frequentere updates
    - cron: '0 6 * * *'   # 06:00 UTC (07:00 CET / 08:00 CEST) - Ochtend
    - cron: '0 12 * * *'  # 12:00 UTC (13:00 CET / 14:00 CEST) - Middag
    - cron: '0 18 * * *'  # 18:00 UTC (19:00 CET / 20:00 CEST) - Avond
  workflow_dispatch: # Handmatig kunnen triggeren

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Backup old beers.json
        run: |
          if [ -f beers.json ]; then
            cp beers.json beers.old.json
          fi
      
      - name: Run scraper
        run: node scrape.js
      
      - name: Detect changes and create changelog
        run: node detect-changes.js
      
      - name: Send notifications for new beers
        if: success()
        run: |
          OLD_COUNT=$(jq '. | length' beers.old.json 2>/dev/null || echo 0)
          NEW_COUNT=$(jq '. | length' beers.json)
          
          if [ $NEW_COUNT -gt $OLD_COUNT ]; then
            DIFF=$((NEW_COUNT - OLD_COUNT))
            echo "Found $DIFF new beers, sending notifications..."
            node send-notifications.js new-beers $DIFF
          else
            echo "No new beers found"
          fi
        env:
          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          VAPID_SUBJECT: ${{ secrets.VAPID_SUBJECT }}
      
      - name: Commit and push if changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add beers.json changelog.json scrape-log.json
          
          if git diff --staged --quiet; then
            echo "No changes detected"
          else
            git commit -m "üç∫ Update beer menu - $(date +'%Y-%m-%d %H:%M')"
            git push
          fi
